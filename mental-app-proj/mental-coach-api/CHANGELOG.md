# CHANGELOG - מערכת Mental Coach API

## [1.6.1] - 2025-01-27

### Added
- **check-auth-method endpoint**: הוספת בדיקת isAdmin לתגובה
  - מחזיר שדה isAdmin (true/false) בתגובה
  - משמש לבדיקת הרשאות admin בממשק הניהול לפני התחברות עם SMS

## [1.6.0] - 2025-01-27

### Added
- **ניהול שיטות התחברות למשתמשים:**
  - הוספת שדה `allowedAuthMethods` למודל המשתמש עם תמיכה ב: email, sms, google, apple
  - הוספת שדה `firebasePhoneNumber` לשמירת מספר טלפון בפורמט E.164 עבור Firebase Auth
  - יכולת עדכון מספר טלפון ב-Firebase Auth דרך ה-API בעת עדכון משתמש
  - endpoint חדש `/api/auth/check-auth-method` לבדיקת שיטת התחברות מורשית למשתמש

### Technical Details
- ולידציה אוטומטית של פורמט מספר טלפון E.164 במודל
- סנכרון אוטומטי של מספר הטלפון עם Firebase Auth בעת עדכון
- ברירת מחדל: email ו-Google/Apple מורשים, SMS לא מורשה
- טיפול בשגיאות Firebase בעת עדכון מספר טלפון

## [1.5.1] - 2025-01-23

### Fixed
- **נתיב `/api/training-programs/{id}/lessons`** מחזיר כעת רשימה בסיסית של שיעורים לכל המשתמשים
- **הפרדה בין סוגי גישה:** רשימת שיעורים (זמין לכולם) vs תוכן מפורט (לפי הרשאות)
- הוספת שדה `hasAccess` לכל שיעור ברשימה המציין אם למשתמש יש גישה לתוכן המלא
- עדכון מדריך האימות עם הסבר מפורט על ההבדל בין סוגי הגישה
- עדכון קולקשן Postman עם הנתיב החדש לקבלת רשימת שיעורים

### Technical Details
- הנתיב מחזיר מידע בסיסי בלבד: כותרת, תיאור, משך זמן, סדר, רמת קושי
- התוכן המפורט (וידאו, תרגילים, מדיה) זמין רק דרך נתיב `/api/lessons/{id}` לפי הרשאות
- שיפור חוויית המשתמש - כעת ניתן לראות את רשימת השיעורים גם ללא מנוי מתאים

## [1.5.0] - 2025-01-23

### Added
- **יצירת קולקשן Postman מלא** עם כל הקריאות במערכת
- **מדריך אימות מפורט** (`Authentication-Guide.md`) עם הסברים על JWT, הרשאות וסוגי מנויים
- **נתיב `/api/lessons`** עם פונקציונליות מלאה לקבלת שיעורים לפי תוכנית אימון
- פונקציה `getAllLessons` בקונטרולר lessons לקבלת שיעורים מסוננים
- סקריפטים אוטומטיים ב-Postman לניהול טוקני אימות
- תמיכה אוטומטית בשמירה וניהול טוקני אימות בקולקשן

### Changed
- **עדכון הרשאות גישה** לתמיכה במנוי "basic" בתוכניות האימון
- שיפור מבנה הנתונים בקונטרולר lessons
- עדכון קובץ המשימות עם התקדמות מלאה

### Fixed
- תיקון בעיות TypeScript בקונטרולר lessons
- תיקון גישה לנתונים הרדקודים במבנה הנכון (`TRAINING_PROGRAM_DATA.data.programs`)
- תיקון בעיות הרשאות במערכת האימון
- תיקון שגיאות קומפילציה עם פרמטרים implicit any

### Files Added
- `documentation/Postman-Collection-Mental-Coach-API.json` - קולקשן מלא עם 50+ קריאות API
- `documentation/Authentication-Guide.md` - מדריך מפורט לתהליכי אימות

### Technical Details
- הקולקשן מסודר בקטגוריות: Authentication, Users, Training Programs, Lessons, Exercises, User Progress, Matches, Goals & Actions, Notifications, General
- המדריך כולל דוגמאות מלאות לכל סוגי הבקשות
- תמיכה במשתני environment לגמישות בפיתוח
- סקריפטי Pre-request ו-Test אוטומטיים

## [1.1.0] - 2024-01-17

### הוספות חדשות 🚀
- **מערכת קורסים דיגיטליים מלאה** - תשתית חדשה לניהול תוכניות אימון מנטלי
  - מודל TrainingProgram - ניהול תוכניות אימון עם קטגוריות, רמות קושי והרשאות גישה
  - מודל Lesson - ניהול שיעורים עם תמיכה בוידאו, אודיו ומסמכים
  - מודל LessonExercise - תרגילים מגוונים (שאלונים, קלט טקסט, רפלקציה, תוכנית פעולה, ויזואליזציה)
  - עדכון מודל User - הוספת מערך mentalTrainingProgress למעקב התקדמות

### Controllers חדשים 🎮
- `training-program-controller.ts` - ניהול תוכניות אימון (CRUD, פרסום, סטטיסטיקות)
- `lesson-controller.ts` - ניהול שיעורים (CRUD, התחלת שיעור, עדכון התקדמות)
- `exercise-controller.ts` - ניהול תרגילים (CRUD, שליחת תשובות, חישוב ציונים)
- `user-progress-controller.ts` - ניהול התקדמות משתמש (הרשמה, מעקב, דוחות)

### Routes חדשים 🛣️
- `/api/training-programs` - ניהול תוכניות אימון
- `/api/lessons` - ניהול שיעורים
- `/api/exercises` - ניהול תרגילים
- `/api/user/training-*` - ניהול התקדמות משתמש

### Middleware חדש 🔒
- `trainingAuthMiddleware.ts` - בדיקות הרשאות מתקדמות לתוכניות, שיעורים ותרגילים

### תכונות מרכזיות ✨
- מערכת הרשאות מבוססת subscriptionTypes ו-specificUsers
- תמיכה בסוגי תרגילים מגוונים עם content גמיש
- מעקב התקדמות מפורט כולל ניקוד וזמני צפייה
- תמיכה ב-requireSequential לחיוב השלמת שיעורים בסדר
- חישוב ציונים אוטומטי לתרגילים
- דוחות התקדמות מפורטים

### תיעוד 📚
- `documentation/SUMMARY.md` - סיכום מפורט של המערכת
- `documentation/EXAMPLES.md` - דוגמאות שימוש מלאות עם curl, JavaScript ו-React
- `documentation/tasks.md` - רשימת משימות

### כלי עזר 🔧
- `scripts/kill-port.mjs` - סקריפט להריגת תהליכים על פורט
- עדכון package.json עם סקריפטים חדשים: `dev:fresh`, `kill-port`

### שיפורים טכניים 🔨
- תיקון שגיאות TypeScript בכל הקבצים החדשים
- שימוש ב-`res.app.locals.user` במקום `req.user`
- תמיכה מלאה ב-TypeScript עם הגדרות טיפוסים

### הערות חשובות ⚠️
- כל ה-routes החדשים דורשים אימות Firebase
- יש להעביר token ב-header של Authorization
- המערכת תומכת בכל סוגי המנויים: basic, advanced, premium

## [1.0.0] - גרסה קודמת
- מערכת בסיסית לניהול כדורגלנים
- ניהול משתמשים, קבוצות, ליגות ומשחקים
- מערכת הודעות עידוד
- אימות Firebase

## [01.07.2025] - Full Lessons Data Integration

### Added
- **הוספת כל 24 השיעורים של תוכנית "מנטליות של ווינר I" למסד הנתונים**
- יצירת קובץ `scripts/training-lessons-data.mjs` עם כל נתוני השיעורים המלאים
- עדכון סקריפט `seed-real-training-data.mjs` להכנסת גם השיעורים למסד
- הוספת סקריפט `seed:real-training` ל-package.json

### Fixed
- **תיקון בעיה קריטית שבה השיעורים לא נשמרו במסד הנתונים**
- כל 24 השיעורים כעת מקושרים לתוכנית האימון במסד
- תיקון מבנה נתוני השיעורים להתאמה למודל Lesson

### Technical Details
- השיעורים כוללים תוכן מלא עבור שיעורים 0-3 ושיעור 14
- שאר השיעורים (4-13, 15-23) מוגדרים כ"תוכן בפיתוח"
- כל השיעורים כוללים הגדרות גישה, ניקוד ומבנה מלא

## [22.01.2025] - Data Integration & API Fixes

### Added
- הוספת לוגים מפורטים לדיבוג בעיות API:
  - לוג כללי לכל בקשה נכנסת עם headers, query ו-body
  - לוגים ב-middleware של האימות (appAuthMiddleware)
  - לוגים בקונטרולר של training-programs
  - לוגים משופרים ב-error handler
  - לוגים ב-routes של training-programs
- הוספת רשימת נתיבים זמינים בהודעת 404
- הוספת redirects אוטומטיים מנתיבים ללא `/api` לנתיבים עם `/api`
- יצירת קובץ הנחיות לתיקון בצד הלקוח: `documentation/frontend-api-fix-instructions.md`
- **הטמעת נתונים אמיתיים לתוכניות אימון:**
  - תוכנית "מנטליות של ווינר I - המעטפת המנטלית" עם 24 שיעורים
  - שיעור מבוא מלא עם הסבר על השימוש בתוכנית
  - שיעורים 1-3 עם תוכן מפורט כולל וידאו מ-Vimeo, מדיטציות ותרגילים
  - שיעור 14 מלא על התמודדות עם פחד מדעת אחרים
  - מבנה מלא של 24 שיעורים עם כותרות וסטטוס פיתוח
- יצירת קובץ נתונים מרכזי: `data/training-program-data.ts`
- סקריפטים להטמעת נתונים: `scripts/seed-complete-training-data.mjs`

### Fixed
- תיקון בעיית נתיבים שגויים - הלקוח פנה ל-`/training-programs` במקום `/api/training-programs`
- החלפת נתוני דמה בנתונים אמיתיים ומפורטים
- הוספת import של `colors` בכל הקבצים שמשתמשים בו
- מחיקת נתונים ישנים ולא נכונים מהמסד

### Changed
- שיפור הודעות שגיאה עם פירוט נתיבים זמינים
- הקונטרולר מחזיר כעת נתונים אמיתיים במקום נתוני דמה
- מבנה נתונים משופר עם תוכן עשיר לכל שיעור

## [21.05.2024] - Initial Setup & Port Fix

### Added
- תיעוד משימות בקובץ `documentation/tasks.md`
- סקריפט לסגירת פורט תפוס: `scripts/kill-port.mjs`
- מערכת לוגים בסיסית
- מבנה בסיסי לתוכניות אימון ושיעורים

### Fixed
- תיקון בעיית פורט 3000 תפוס
- הוספת middleware לטיפול בשגיאות

### Security
- הוספת אימות Firebase למערכת
- middleware לבדיקת הרשאות משתמש

### Known Issues
- מפתח SendGrid אינו מוגדר כראוי בקובץ .env

## [2025-01-02] - תיקון בעיית JSON Parsing
### תוקן
- תיקון בעיית parsing כאשר האפליקציה שולחת `null` בתור body בבקשות POST
- הוספת middleware מותאם אישית ב-server.ts שמטפל ב-JSON לא תקין
- הוספת בדיקת body ריק בפונקציה startLesson
- הסרת כפילות של express.json() middleware
- תיקון בעיית "user.save is not a function" על ידי טעינת המשתמש המלא מהמסד נתונים בפונקציות startLesson ו-updateLessonProgress
- תיקון בעיית אימות Firebase - הסרת "Bearer " prefix מהטוקן לפני פירוש

## [2025-01-02] - ביטול זמני של בדיקות הרשאות לקורסים
### שונה
- ביטול בדיקות הרשאות בכל הפונקציות הבאות (hasAccess = true תמיד):
  - `getAllLessons` - כל המשתמשים יכולים לראות רשימת שיעורים
  - `getLesson` - כל המשתמשים יכולים לראות פרטי שיעור
  - `getLessonExercises` - כל המשתמשים יכולים לראות תרגילים
  - `startLesson` - כל המשתמשים יכולים להתחיל שיעור
  - `getTrainingProgram` - כל המשתמשים יכולים לראות פרטי תוכנית
  - `getProgramLessons` - כל המשתמשים יכולים לראות רשימת שיעורים בתוכנית
- השדה `hasAccess` מוחזר כ-`true` לכל המשתמשים בתקופת הבדיקות 

## 📅 יום שני, 27 בינואר 2025

### ✅ הוספת endpoint לקבלת כל תשובות המשתמש
- נתיב חדש: GET /api/user/exercise-responses
- החזרת כל התשובות של המשתמש מכל התוכניות
- פרטים מלאים כולל: תוכנית, שיעור, תרגיל, תשובות, ציון וזמן
- מיון לפי תאריך השלמה (החדשות קודם) 